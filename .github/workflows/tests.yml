name: Tests
on:
  push:
  pull_request:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Boost
        run: sudo apt-get update && sudo apt-get install -y libboost-all-dev

      - name: Set up CMake
        uses: jwlawson/actions-setup-cmake@v1

      - name: Configure (Release)
        run: cmake -S . -B build -DCMAKE_BUILD_TYPE=Release

      - name: Build all
        run: cmake --build build --config Release -j

      # âœ… Put real binaries under dist/bin via CMake install rules
      - name: Install to prefix
        run: cmake --install build --config Release --prefix "$PWD/dist"

      - name: Show installed tree
        run: find dist -maxdepth 3 -type f -print

      - name: Upload installed binaries
        uses: actions/upload-artifact@v4
        with:
          name: pebbli-dist
          path: dist/bin/*
  test:
    runs-on: ubuntu-latest
    needs: [build]
    steps:
      - uses: actions/checkout@v4

      - name: Download binaries
        uses: actions/download-artifact@v4
        with:
          name: pebbli-dist
          path: ./dist/bin

      - name: Make downloaded files executable
        run: |
          set -euo pipefail
          if compgen -G "./dist/bin/*" > /dev/null; then
            chmod +x ./dist/bin/* || true
          fi

      - name: Locate binary
        id: bin
        shell: bash
        run: |
          set -euo pipefail
          BIN="$(find ./dist/bin -maxdepth 1 -type f -executable | head -n1)"
          if [ -z "${BIN:-}" ]; then
            echo "Nothing executable in dist/bin"; ls -lR ./dist || true; exit 1
          fi
          echo "path=$BIN" >> "$GITHUB_OUTPUT"
          echo "Using: $BIN"

      # Detect whether repo provides test fixtures
      - name: Check for test fixtures
        id: fixtures
        run: |
          if [[ -f tests/input.txt && -f tests/expected.out ]]; then
            echo "have=true" >> "$GITHUB_OUTPUT"
          else
            echo "have=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Run internal test mode (if supported)
        run: |
          set -e
          "${{ steps.bin.outputs.path }}" --dev test || true

      # Only run comparison when fixtures exist
      - name: Produce outputs for comparison
        if: steps.fixtures.outputs.have == 'true'
        shell: bash
        run: |
          set -euo pipefail
          "${{ steps.bin.outputs.path }}" < tests/input.txt | tee actual.out
          cp tests/expected.out expected.out

      - name: Normalize and compare outputs
        if: steps.fixtures.outputs.have == 'true'
        shell: bash
        run: |
          set -euo pipefail
          sed -E 's/^([>]{1,3})[[:space:]]+//; /^\s*$/d' actual.out > actual.norm
          sed -E 's/^[[:space:]]+|[[:space:]]+$//g' expected.out > expected.norm
          cat > subseq.awk <<'AWK'
          NR==FNR { exp[++n]=$0; next }
          { gsub(/^[[:space:]]+|[[:space:]]+$/,""); if ($0!="") act[++m]=$0 }
          END {
            i=1; j=1
            while (i<=n && j<=m) {
              if (act[j]==exp[i]) { i++; j++ } else j++
            }
            if (i<=n) { print "Missing expected line:", exp[i] > "/dev/stderr"; exit 1 }
          }
          AWK
          awk -f subseq.awk expected.norm actual.norm
          echo "All REPL checks passed."

      # Optional: smoke test path when fixtures are absent
      - name: Smoke test (no fixtures)
        if: steps.fixtures.outputs.have == 'false'
        run: |
          set -euo pipefail
          echo "No tests/ fixtures found; running a smoke test."
          "${{ steps.bin.outputs.path }}" --version || "${{ steps.bin.outputs.path }}" --help || true