name: Tests

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest

    permissions:
      packages: read # Needed to pull from GHCR

    steps:
    - uses: actions/checkout@v4

    # Authenticate to GitHub Container Registry (GHCR)
    - name: Log in to GHCR
      run: echo "${{ secrets.GHCR_PAT }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

    # Run Dev Container CI
    - uses: devcontainers/ci@v0.3
      with:
        imageName: ghcr.io/kejunp/pebbl-devcontainer
        push: never  # Skip pushing unless you want to update the image
        noCache: false

    # Don't know why I need to do this, because this is already in the dev container, but this is a workaround
    - name: Install Boost
      run: sudo apt install libboost-all-dev

    # CMake and Test steps inside container
    - name: Set up CMake
      uses: jwlawson/actions-setup-cmake@v1

    - name: Configure
      run: cmake -S . -B build

    - name: Build
      run: cmake --build build

    - name: Test
      run: ctest --test-dir build