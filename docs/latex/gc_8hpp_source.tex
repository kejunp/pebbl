\doxysection{gc.\+hpp}
\hypertarget{gc_8hpp_source}{}\label{gc_8hpp_source}\index{src/runtime/gc.hpp@{src/runtime/gc.hpp}}
\mbox{\hyperlink{gc_8hpp}{Go to the documentation of this file.}}
\begin{DoxyCode}{0}
\DoxyCodeLine{00001\ }
\DoxyCodeLine{00006\ \textcolor{preprocessor}{\#pragma\ once}}
\DoxyCodeLine{00007\ \textcolor{preprocessor}{\#include\ <cstddef>}}
\DoxyCodeLine{00008\ \textcolor{preprocessor}{\#include\ <cstdint>}}
\DoxyCodeLine{00009\ \textcolor{preprocessor}{\#include\ <memory>}}
\DoxyCodeLine{00010\ \textcolor{preprocessor}{\#include\ <type\_traits>}}
\DoxyCodeLine{00011\ \textcolor{preprocessor}{\#include\ <vector>}}
\DoxyCodeLine{00012\ }
\DoxyCodeLine{00013\ \textcolor{keyword}{struct\ }\mbox{\hyperlink{structGCObject}{GCObject}};}
\DoxyCodeLine{00014\ \textcolor{keyword}{class\ }\mbox{\hyperlink{classGCHeap}{GCHeap}};}
\DoxyCodeLine{00015\ \textcolor{keyword}{class\ }\mbox{\hyperlink{classTracer}{Tracer}};}
\DoxyCodeLine{00016\ }
\DoxyCodeLine{00021\ \textcolor{keyword}{template}\ <\textcolor{keyword}{typename}\ T>}
\DoxyCodeLine{00022\ \textcolor{keyword}{concept\ }\mbox{\hyperlink{conceptGCManaged}{GCManaged}}\ =\ std::is\_base\_of\_v<GCObject,\ T>;}
\DoxyCodeLine{00023\ }
\DoxyCodeLine{00028\ \textcolor{keyword}{template}\ <GCManaged\ T>}
\DoxyCodeLine{00029\ \textcolor{keyword}{using\ }\mbox{\hyperlink{gc_8hpp_ad791b40e4c777fb92c33a1e9aa364331}{GCRef}}\ =\ T*;}
\DoxyCodeLine{00030\ }
\DoxyCodeLine{00034\ \textcolor{keyword}{enum\ class}\ \mbox{\hyperlink{gc_8hpp_ad47f9bc93431f4e02b6b22820b3ee4db}{GCTag}}\ :\ uint8\_t\ \{\ }
\DoxyCodeLine{00035\ \ \ \mbox{\hyperlink{gc_8hpp_ad47f9bc93431f4e02b6b22820b3ee4dba63b588d5559f64f89a416e656880b949}{STRING}},\ \ \ }
\DoxyCodeLine{00036\ \ \ \mbox{\hyperlink{gc_8hpp_ad47f9bc93431f4e02b6b22820b3ee4dbacb4fb1757fb37c43cded35d3eb857c43}{ARRAY}},\ \ \ \ }
\DoxyCodeLine{00037\ \ \ \mbox{\hyperlink{gc_8hpp_ad47f9bc93431f4e02b6b22820b3ee4dbad7f73f951e7f6c4ed5e17c4204f4032e}{DICT}},\ \ \ \ \ }
\DoxyCodeLine{00038\ \ \ \mbox{\hyperlink{gc_8hpp_ad47f9bc93431f4e02b6b22820b3ee4dbab27025b4b0dce496c519e0d5c69acaf8}{CLOSURE}},\ \ }
\DoxyCodeLine{00039\ \ \ \mbox{\hyperlink{gc_8hpp_ad47f9bc93431f4e02b6b22820b3ee4dbac24465ccaa62ea56305df0848e0f55ed}{UPVALUE}},\ \ }
\DoxyCodeLine{00040\ \ \ \mbox{\hyperlink{gc_8hpp_ad47f9bc93431f4e02b6b22820b3ee4dba6a72a6a776662a244f82d31e9274a07b}{FUNCTION}}\ \ }
\DoxyCodeLine{00041\ \};}
\DoxyCodeLine{00042\ }
\DoxyCodeLine{00050\ \textcolor{keyword}{struct\ }\mbox{\hyperlink{structGCObject}{GCObject}}\ \{}
\DoxyCodeLine{00051\ \ \ \textcolor{keywordtype}{bool}\ \mbox{\hyperlink{structGCObject_a1279a78425557f3becddf3e01a9463ac}{marked}}\ =\ \textcolor{keyword}{false};\ \ \ \ \ \ \ \ }
\DoxyCodeLine{00052\ \ \ \mbox{\hyperlink{gc_8hpp_ad47f9bc93431f4e02b6b22820b3ee4db}{GCTag}}\ \mbox{\hyperlink{structGCObject_a230915377c2e7a38457cc395fde3f26a}{tag}};\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ }
\DoxyCodeLine{00053\ \ \ \mbox{\hyperlink{structGCObject}{GCObject}}*\ \mbox{\hyperlink{structGCObject_ada46f984810ae3794a07c7a77b95fb93}{next}}\ =\ \textcolor{keyword}{nullptr};\ \ \ }
\DoxyCodeLine{00054\ }
\DoxyCodeLine{00059\ \ \ \textcolor{keyword}{explicit}\ \mbox{\hyperlink{structGCObject_ae66224d8eab8262dabef8685be66bd73}{GCObject}}(\mbox{\hyperlink{gc_8hpp_ad47f9bc93431f4e02b6b22820b3ee4db}{GCTag}}\ t)\ :\ \mbox{\hyperlink{structGCObject_a230915377c2e7a38457cc395fde3f26a}{tag}}(t)\ \{}
\DoxyCodeLine{00060\ \ \ \}}
\DoxyCodeLine{00061\ }
\DoxyCodeLine{00065\ \ \ \textcolor{keyword}{virtual}\ \mbox{\hyperlink{structGCObject_a92ed0e23925277fa520a69d5eaa4b87f}{\string~GCObject}}()\ =\ \textcolor{keywordflow}{default};}
\DoxyCodeLine{00066\ }
\DoxyCodeLine{00074\ \ \ \textcolor{keyword}{virtual}\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{structGCObject_a6daee7ed3b0b566d7074fe0dbc3d5083}{trace}}(\mbox{\hyperlink{classTracer}{Tracer}}\&\ tracer)\ =\ 0;}
\DoxyCodeLine{00075\ \};}
\DoxyCodeLine{00076\ }
\DoxyCodeLine{00084\ \textcolor{keyword}{class\ }\mbox{\hyperlink{classRootHandle}{RootHandle}}\ \{}
\DoxyCodeLine{00085\ \textcolor{keyword}{public}:}
\DoxyCodeLine{00091\ \ \ \mbox{\hyperlink{classRootHandle}{RootHandle}}(\mbox{\hyperlink{classGCHeap}{GCHeap}}\&\ heap,\ \mbox{\hyperlink{structGCObject}{GCObject}}*\&\ ref);}
\DoxyCodeLine{00092\ }
\DoxyCodeLine{00096\ \ \ \mbox{\hyperlink{classRootHandle_a7f22143fb59317e080c50c589abacac7}{\string~RootHandle}}();}
\DoxyCodeLine{00097\ }
\DoxyCodeLine{00101\ \ \ \mbox{\hyperlink{classRootHandle_a6db1eb3932662cd4b627f8f9b059968f}{RootHandle}}(\textcolor{keyword}{const}\ \mbox{\hyperlink{classRootHandle}{RootHandle}}\&)\ =\ \textcolor{keyword}{delete};}
\DoxyCodeLine{00102\ }
\DoxyCodeLine{00106\ \ \ \mbox{\hyperlink{classRootHandle}{RootHandle}}\&\ \mbox{\hyperlink{classRootHandle_ac6bee67cc96f5a5bcee142389b4b75bb}{operator=}}(\textcolor{keyword}{const}\ \mbox{\hyperlink{classRootHandle}{RootHandle}}\&)\ =\ \textcolor{keyword}{delete};}
\DoxyCodeLine{00107\ }
\DoxyCodeLine{00108\ \textcolor{keyword}{private}:}
\DoxyCodeLine{00109\ \ \ \mbox{\hyperlink{classGCHeap}{GCHeap}}\&\ \mbox{\hyperlink{classRootHandle_a29161bcae4ab51e8ad3cee3bae7f7b1c}{heap\_}};\ \ \ \ \ \ \ \ }
\DoxyCodeLine{00110\ \ \ \mbox{\hyperlink{structGCObject}{GCObject}}*\&\ \mbox{\hyperlink{classRootHandle_a6fb0937ae7692eee00efb3f44946ea68}{ref\_}};\ \ \ \ \ \ }
\DoxyCodeLine{00111\ \};}
\DoxyCodeLine{00112\ }
\DoxyCodeLine{00120\ \textcolor{keyword}{class\ }\mbox{\hyperlink{classGCHeap}{GCHeap}}\ \{}
\DoxyCodeLine{00121\ \textcolor{keyword}{public}:}
\DoxyCodeLine{00125\ \ \ \mbox{\hyperlink{classGCHeap_a8da24272a35a3a4c45c60bbdc4d9fa54}{GCHeap}}();}
\DoxyCodeLine{00126\ }
\DoxyCodeLine{00130\ \ \ \mbox{\hyperlink{classGCHeap_a26dd24ce862b0a82add8165763197865}{\string~GCHeap}}();}
\DoxyCodeLine{00131\ }
\DoxyCodeLine{00143\ \ \ \textcolor{keyword}{template}\ <\textcolor{keyword}{typename}\ T,\ \textcolor{keyword}{typename}...\ Args>}
\DoxyCodeLine{00144\ \ \ \mbox{\hyperlink{gc_8hpp_ad791b40e4c777fb92c33a1e9aa364331}{GCRef<T>}}\ \mbox{\hyperlink{classGCHeap_ab1fa78330f0d67914b3bd7e0bc257eeb}{allocate}}(Args\&\&...\ args)\ \{}
\DoxyCodeLine{00145\ \ \ \ \ \textcolor{keyword}{static\_assert}(std::is\_base\_of\_v<GCObject,\ T>,\ \textcolor{stringliteral}{"{}pebbli:\ Fatal:\ T\ in\ GCHeap::allocate\ must\ be\ a\ GCObject\ or\ derived\ from\ a\ GCObject"{}});}
\DoxyCodeLine{00146\ \ \ \ \ }
\DoxyCodeLine{00147\ \ \ \ \ T*\ obj\ =\ \textcolor{keyword}{new}\ T(std::forward<Args>(args)...);}
\DoxyCodeLine{00148\ \ \ \ \ obj-\/>next\ =\ \mbox{\hyperlink{classGCHeap_a5abfbd848632c24558e47b4bdd7bedc8}{objects\_}};}
\DoxyCodeLine{00149\ \ \ \ \ \mbox{\hyperlink{classGCHeap_a5abfbd848632c24558e47b4bdd7bedc8}{objects\_}}\ =\ obj;}
\DoxyCodeLine{00150\ \ \ \ \ \mbox{\hyperlink{classGCHeap_ab5cdc22c1704939684c8d3668f3ac1d2}{object\_count\_}}++;}
\DoxyCodeLine{00151\ \ \ \ \ }
\DoxyCodeLine{00152\ \ \ \ \ \textcolor{keywordflow}{if}\ (\mbox{\hyperlink{classGCHeap_ab5cdc22c1704939684c8d3668f3ac1d2}{object\_count\_}}\ >=\ \mbox{\hyperlink{classGCHeap_a3223a10a6729ea3c9f5e6236794a3277}{next\_gc\_}})\ \{}
\DoxyCodeLine{00153\ \ \ \ \ \ \ \mbox{\hyperlink{classGCHeap_adce58b9833e82a314a626d43234c335c}{collect}}();}
\DoxyCodeLine{00154\ \ \ \ \ \}}
\DoxyCodeLine{00155\ \ \ \ \ }
\DoxyCodeLine{00156\ \ \ \ \ \textcolor{keywordflow}{return}\ obj;}
\DoxyCodeLine{00157\ \ \ \}}
\DoxyCodeLine{00158\ }
\DoxyCodeLine{00163\ \ \ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classGCHeap_acc5003e175344127b5fe3a1d26e37dd6}{add\_root}}(\mbox{\hyperlink{structGCObject}{GCObject}}**\ ref);}
\DoxyCodeLine{00164\ }
\DoxyCodeLine{00169\ \ \ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classGCHeap_ac939b5b46022555fedcf65cb175a50d6}{remove\_root}}(\mbox{\hyperlink{structGCObject}{GCObject}}**\ ref);}
\DoxyCodeLine{00170\ }
\DoxyCodeLine{00177\ \ \ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classGCHeap_adce58b9833e82a314a626d43234c335c}{collect}}();}
\DoxyCodeLine{00178\ }
\DoxyCodeLine{00179\ \textcolor{keyword}{private}:}
\DoxyCodeLine{00180\ \ \ \mbox{\hyperlink{structGCObject}{GCObject}}*\ \mbox{\hyperlink{classGCHeap_a5abfbd848632c24558e47b4bdd7bedc8}{objects\_}};\ \ \ \ \ \ \ \ \ }
\DoxyCodeLine{00181\ \ \ \textcolor{keywordtype}{size\_t}\ \mbox{\hyperlink{classGCHeap_ab5cdc22c1704939684c8d3668f3ac1d2}{object\_count\_}};\ \ \ \ \ \ \ }
\DoxyCodeLine{00182\ \ \ \textcolor{keywordtype}{size\_t}\ \mbox{\hyperlink{classGCHeap_a3223a10a6729ea3c9f5e6236794a3277}{next\_gc\_}};\ \ \ \ \ \ \ \ \ \ \ }
\DoxyCodeLine{00183\ }
\DoxyCodeLine{00184\ \ \ std::vector<GCObject**>\ \mbox{\hyperlink{classGCHeap_a88622e22138bf593b95cf078180c449b}{roots\_}};\ \ }
\DoxyCodeLine{00185\ }
\DoxyCodeLine{00191\ \ \ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classGCHeap_a33732177e157859c4b1833320175f3d7}{mark}}();}
\DoxyCodeLine{00192\ }
\DoxyCodeLine{00198\ \ \ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classGCHeap_ab78442507b6ab9b24af862ef97d7e7d8}{sweep}}();}
\DoxyCodeLine{00199\ }
\DoxyCodeLine{00200\ \ \ \textcolor{keyword}{friend}\ \textcolor{keyword}{class\ }\mbox{\hyperlink{classRootHandle}{RootHandle}};}
\DoxyCodeLine{00201\ \};}
\DoxyCodeLine{00202\ }
\DoxyCodeLine{00210\ \textcolor{keyword}{class\ }\mbox{\hyperlink{classTracer}{Tracer}}\ \{}
\DoxyCodeLine{00211\ \textcolor{keyword}{public}:}
\DoxyCodeLine{00216\ \ \ \textcolor{keyword}{explicit}\ \mbox{\hyperlink{classTracer_a27b316126186c63ae6e9c0e6510b914c}{Tracer}}(\mbox{\hyperlink{classGCHeap}{GCHeap}}\&\ heap)\ :\ \mbox{\hyperlink{classTracer_a7e283d54bcc204c7c2bc2e69450bb347}{heap\_}}(heap)\ \{\}}
\DoxyCodeLine{00217\ }
\DoxyCodeLine{00225\ \ \ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classTracer_a81885e30cdeeec4ef5fc0cfa5a225054}{mark}}(\mbox{\hyperlink{structGCObject}{GCObject}}*\ obj);}
\DoxyCodeLine{00226\ }
\DoxyCodeLine{00227\ \textcolor{keyword}{private}:}
\DoxyCodeLine{00228\ \ \ \mbox{\hyperlink{classGCHeap}{GCHeap}}\&\ \mbox{\hyperlink{classTracer_a7e283d54bcc204c7c2bc2e69450bb347}{heap\_}};\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ }
\DoxyCodeLine{00229\ \ \ std::vector<GCObject*>\ \mbox{\hyperlink{classTracer_a4a25ba2968fcd38f03222e0a9ed46996}{worklist\_}};\ \ \ }
\DoxyCodeLine{00230\ \};}

\end{DoxyCode}
